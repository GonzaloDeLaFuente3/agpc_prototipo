<!-- static/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Agente Experto en Gesti√≥n Probabil√≠stica de Contextos (AGPC) - Prototipo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">Agente Experto en Gesti√≥n Probabil√≠stica de Contextos (AGPC) Prototipo</h1>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Agregar Contexto</h2>
            <input id="titulo" placeholder="T√≠tulo del contexto" class="border p-2 w-full mb-2" />
            <textarea id="texto" placeholder="Texto del contexto" class="border p-2 w-full mb-2"></textarea>
            <button onclick="agregarContexto()" class="bg-blue-600 text-white px-4 py-2 rounded">Agregar</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Preguntar al Sistema</h2>
            <input id="pregunta" placeholder="Escrib√≠ tu pregunta..." class="border p-2 w-full mb-2" />
            <button onclick="preguntar()" class="bg-green-600 text-white px-4 py-2 rounded">Preguntar</button>
            
            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                <p class="text-sm text-blue-700">
                    ü§ñ <strong>IA Autom√°tica:</strong> El sistema buscar√° autom√°ticamente los contextos m√°s relevantes para tu pregunta.
                </p>
            </div>
            
            <div id="respuesta" class="mt-3 p-3 bg-gray-50 border rounded whitespace-pre-wrap text-gray-700"></div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Todos los Contextos</h2>
            <button onclick="mostrarContextos()" class="mb-2 bg-indigo-600 text-white px-4 py-2 rounded">Cargar Contextos</button>
            <div id="todosContextos" class="text-sm whitespace-pre-wrap bg-gray-100 p-3 rounded"></div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">B√∫squeda Sem√°ntica</h2>
            <input id="textoBusqueda" placeholder="Escrib√≠ algo relacionado al contenido..." class="border p-2 w-full mb-2" />
            <button onclick="buscarSemantico()" class="bg-pink-600 text-white px-4 py-2 rounded">Buscar</button>
            <div id="resultadosBusqueda" class="mt-4 text-sm space-y-3"></div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-xl font-semibold mb-2">Visualizaci√≥n del Grafo</h2>
        <div id="grafo" style="height: 400px;"></div>
        <button onclick="cargarGrafo()" class="mt-3 bg-purple-600 text-white px-4 py-2 rounded">Actualizar Grafo</button>
        </div>
    </div>

    <script>
        async function agregarContexto() {
            const titulo = document.getElementById('titulo').value;
            const texto = document.getElementById('texto').value;

            if (!titulo || !texto) {
                alert("Por favor complet√° t√≠tulo y texto.");
                return;
            }

            const res = await axios.post('/contexto/', { titulo, texto });
            alert(`Contexto agregado autom√°ticamente con relaciones detectadas! ID interno: ${res.data.id}`);
            //actualizar autom√°ticamente
            cargarGrafo();
            mostrarContextos();
        }

        async function preguntar() {
            const pregunta = document.getElementById('pregunta').value;

            if (!pregunta.trim()) {
                alert("Por favor escrib√≠ una pregunta.");
                return;
            }

            // Mostrar indicador de carga
            const respuestaDiv = document.getElementById('respuesta');
            respuestaDiv.innerHTML = "üîç Buscando contextos relevantes y generando respuesta...";

            try {
                const res = await axios.get(`/preguntar/?pregunta=${encodeURIComponent(pregunta)}`);
                respuestaDiv.innerText = res.data.respuesta;
            } catch (error) {
                respuestaDiv.innerText = `Error: ${error.message}`;
            }
        }

        async function cargarGrafo() {
        const res = await axios.get('/contexto/');
        const contextos = res.data;

        const nodes = Object.keys(contextos).map(id => ({
            id: id,
            label: contextos[id].titulo
        }));

        const edges = [];
        for (const [id, data] of Object.entries(contextos)) {
            data.relaciones.forEach(rel => {
            edges.push({ from: id, to: rel });
            });
        }

        const container = document.getElementById('grafo');
        const network = new vis.Network(container, {
            nodes: new vis.DataSet(nodes),
            edges: new vis.DataSet(edges)
        }, {
            nodes: { shape: 'dot', size: 12 },
            edges: { arrows: 'to' },
            physics: { stabilization: true }
        });
        }

        cargarGrafo(); // carga inicial

        async function mostrarContextos() {
            const res = await axios.get('/contexto/');
            const contextos = res.data;

            let salida = "";
            for (const [id, datos] of Object.entries(contextos)) {
                salida += `üü¶ T√≠tulo: ${datos.titulo}\nüìÑ Texto: ${datos.texto}\nüîó Relacionados: ${datos.relaciones.map(rid => contextos[rid]?.titulo || rid).join(', ') || 'Ninguno'}\nüîë Palabras clave: ${datos.palabras_clave.join(', ') || 'Ninguna'}\n\n`;
            }

            document.getElementById("todosContextos").innerText = salida || "No hay contextos almacenados a√∫n.";
        }

        async function buscarSemantico() {
            const texto = document.getElementById('textoBusqueda').value.trim();
            if (!texto) return;

            const res = await axios.get(`/buscar/?texto=${encodeURIComponent(texto)}`);
            const datos = res.data;

            const container = document.getElementById('resultadosBusqueda');
            container.innerHTML = '';

            if (Object.keys(datos).length === 0) {
                container.innerHTML = "<p>No se encontraron resultados.</p>";
                return;
            }

            for (const [id, info] of Object.entries(datos)) {
                const div = document.createElement("div");
                div.className = "p-3 bg-gray-100 rounded border-l-4 border-pink-600 shadow";
                div.innerHTML = `
                <strong>üü£ ID:</strong> ${id}<br>
                <strong>üìÑ Texto:</strong> ${info.texto}
                `;
                container.appendChild(div);
            }
        }


    </script>
</body>
</html>
