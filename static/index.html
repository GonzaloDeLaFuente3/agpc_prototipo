<!-- static/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Agente Experto en Gesti√≥n Probabil√≠stica de Contextos (AGPC) - Prototipo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">Agente Experto en Gesti√≥n Probabil√≠stica de Contextos (AGPC) Prototipo</h1>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Agregar Contexto</h2>
            <input id="titulo" placeholder="T√≠tulo del contexto" class="border p-2 w-full mb-2" />
            <textarea id="texto" placeholder="Texto del contexto" class="border p-2 w-full mb-2"></textarea>
            <button onclick="agregarContexto()" class="bg-blue-600 text-white px-4 py-2 rounded">Agregar</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Preguntar al Sistema</h2>
            <input id="pregunta" placeholder="Escrib√≠ tu pregunta..." class="border p-2 w-full mb-2" />
            <button onclick="preguntar()" class="bg-green-600 text-white px-4 py-2 rounded">Preguntar</button>
            
            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                <p class="text-sm text-blue-700">
                    ü§ñ <strong>IA Autom√°tica:</strong> El sistema buscar√° autom√°ticamente los contextos m√°s relevantes para tu pregunta.
                </p>
            </div>
            
            <div id="respuesta" class="mt-3 p-3 bg-gray-50 border rounded whitespace-pre-wrap text-gray-700"></div>
            
            <!-- Bot√≥n para agregar respuesta como contexto -->
            <div id="botonAgregarRespuesta" class="mt-3" style="display: none;">
                <button onclick="agregarRespuestaComoContexto()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 transition-colors">
                    ‚ûï Agregar esta respuesta como nuevo contexto
                </button>
                <p class="text-sm text-gray-600 mt-1">üí° √ötil para guardar respuestas valiosas y que el sistema las use en futuras consultas</p>
            </div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Todos los Contextos</h2>
            <button onclick="mostrarContextos()" class="mb-2 bg-indigo-600 text-white px-4 py-2 rounded">Cargar Contextos</button>
            <div id="todosContextos" class="text-sm whitespace-pre-wrap bg-gray-100 p-3 rounded"></div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">B√∫squeda Sem√°ntica</h2>
            <input id="textoBusqueda" placeholder="Escrib√≠ algo relacionado al contenido..." class="border p-2 w-full mb-2" />
            <button onclick="buscarSemantico()" class="bg-pink-600 text-white px-4 py-2 rounded">Buscar</button>
            <div id="resultadosBusqueda" class="mt-4 text-sm space-y-3"></div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Visualizaci√≥n del Grafo</h2>
            <div class="mb-3 p-3 bg-purple-50 border border-purple-200 rounded">
                <p class="text-sm text-purple-700">
                    üï∏Ô∏è <strong>Grafo Inteligente:</strong> Hac√© click en cualquier nodo para ver su informaci√≥n completa. Los nodos muestran los t√≠tulos de los contextos y las flechas indican las relaciones autom√°ticas.
                </p>
            </div>
            <div id="grafo" style="height: 400px; border: 1px solid #e5e7eb; border-radius: 8px;"></div>
            <button onclick="cargarGrafo()" class="mt-3 bg-purple-600 text-white px-4 py-2 rounded">Actualizar Grafo</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">Estad√≠sticas del Grafo</h2>
            <button onclick="cargarEstadisticas()" class="mb-3 bg-gray-600 text-white px-4 py-2 rounded">Actualizar Estad√≠sticas</button>
            <div id="estadisticas" class="text-sm bg-gray-50 p-3 rounded mb-4"></div>
            
            <!-- Nuevas funcionalidades de grafo -->
            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                    <h3 class="font-semibold text-blue-800 mb-2 ">üéØ Contextos M√°s Centrales</h3>
                    <button onclick="mostrarContextosCentrales()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Ver Top 5</button>
                    <div id="contextosCentrales" class="mt-2 text-xs"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ultimaRespuesta = "";
        let ultimaPregunta = "";

        async function agregarContexto() {
            const titulo = document.getElementById('titulo').value;
            const texto = document.getElementById('texto').value;

            if (!titulo || !texto) {
                alert("Por favor complet√° t√≠tulo y texto.");
                return;
            }

            try {
                const res = await axios.post('/contexto/', { titulo, texto });
                alert(`‚úÖ Contexto agregado autom√°ticamente con relaciones detectadas! ID interno: ${res.data.id}`);
                
                // Limpiar campos
                document.getElementById('titulo').value = '';
                document.getElementById('texto').value = '';
                
                //actualizar autom√°ticamente
                cargarGrafo();
                mostrarContextos();
            } catch (error) {
                alert(`‚ùå Error al agregar contexto: ${error.message}`);
            }
        }

        async function preguntar() {
            const pregunta = document.getElementById('pregunta').value;

            if (!pregunta.trim()) {
                alert("Por favor escrib√≠ una pregunta.");
                return;
            }

            // Mostrar indicador de carga
            const respuestaDiv = document.getElementById('respuesta');
            const botonDiv = document.getElementById('botonAgregarRespuesta');
            respuestaDiv.innerHTML = "üîç Buscando contextos relevantes y generando respuesta...";
            botonDiv.style.display = 'none';

            try {
                const res = await axios.get(`/preguntar/?pregunta=${encodeURIComponent(pregunta)}`);
                respuestaDiv.innerText = res.data.respuesta;
                
                // Guardar para uso posterior
                ultimaRespuesta = res.data.respuesta;
                ultimaPregunta = pregunta;
                
                // Mostrar bot√≥n para agregar como contexto (solo si hay respuesta v√°lida)
                if (res.data.respuesta && !res.data.respuesta.startsWith("[ERROR]")) {
                    botonDiv.style.display = 'block';
                }
                
            } catch (error) {
                respuestaDiv.innerText = `Error: ${error.message}`;
                botonDiv.style.display = 'none';
            }
        }

        async function agregarRespuestaComoContexto() {
            if (!ultimaRespuesta || !ultimaPregunta) {
                alert("‚ùå No hay una respuesta v√°lida para agregar como contexto.");
                return;
            }

            // Pedir t√≠tulo al usuario
            const tituloSugerido = `Respuesta: ${ultimaPregunta.substring(0, 50)}${ultimaPregunta.length > 50 ? '...' : ''}`;
            const titulo = prompt(`üí° Ingres√° un t√≠tulo para este nuevo contexto:\n\n(Sugerencia basada en tu pregunta)`, tituloSugerido);
            
            if (!titulo || !titulo.trim()) {
                alert("‚ùå Se necesita un t√≠tulo para crear el contexto.");
                return;
            }

            try {
                // Limpiar la respuesta (quitar la parte de "contextos utilizados")
                const respuestaLimpia = ultimaRespuesta.split('\n\nüìö Contextos utilizados:')[0];
                
                const res = await axios.post('/contexto/', { 
                    titulo: titulo.trim(), 
                    texto: respuestaLimpia 
                });
                
                alert(`‚úÖ ¬°Respuesta agregada como nuevo contexto!\n\nT√≠tulo: "${titulo.trim()}"\nID: ${res.data.id}\n\nYa puede ser usada en futuras consultas.`);
                
                // Ocultar el bot√≥n despu√©s de agregar
                document.getElementById('botonAgregarRespuesta').style.display = 'none';
                
                // Actualizar visualizaciones
                cargarGrafo();
                mostrarContextos();
                
            } catch (error) {
                alert(`‚ùå Error al agregar respuesta como contexto: ${error.message}`);
            }
        }

        async function cargarGrafo() {
            try {
                // Usar el nuevo endpoint optimizado para visualizaci√≥n
                const res = await axios.get('/grafo/visualizacion/');
                const datos = res.data;

                // Verificar si hay nodos para mostrar
                if (!datos.nodes || datos.nodes.length === 0) {
                    const container = document.getElementById('grafo');
                    container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><p>No hay contextos para visualizar. Agreg√° algunos contextos primero.</p></div>';
                    return;
                }

                const container = document.getElementById('grafo');
                
                // Configurar colores por grupo (cantidad de palabras clave)
                const colorPalette = ['#e3f2fd', '#f3e5f5', '#e8f5e8', '#fff3e0', '#fce4ec'];
                
                // Procesar nodos con colores din√°micos
                const nodes = datos.nodes.map(node => ({
                    ...node,
                    color: {
                        background: colorPalette[node.group % colorPalette.length] || '#e3f2fd',
                        border: '#1976d2',
                        highlight: { background: '#bbdefb', border: '#0d47a1' }
                    },
                    font: { color: '#1565c0', size: 12, face: 'Arial' }
                }));

                // Procesar edges con informaci√≥n de peso
                const edges = datos.edges.map(edge => ({
                    ...edge,
                    color: {
                        color: edge.weight > 0.3 ? '#4caf50' : '#90a4ae',
                        highlight: '#37474f'
                    },
                    width: Math.max(1, edge.weight * 5), // Grosor basado en similitud
                    smooth: { enabled: true, type: 'continuous' }
                }));

                const network = new vis.Network(container, {
                    nodes: new vis.DataSet(nodes),
                    edges: new vis.DataSet(edges)
                }, {
                    nodes: { 
                        shape: 'box',
                        size: 20,
                        borderWidth: 2,
                        shadow: true,
                        margin: 10
                    },
                    edges: { 
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } }
                    },
                    physics: { 
                        stabilization: { iterations: 200 },
                        barnesHut: { 
                            gravitationalConstant: -8000, 
                            springConstant: 0.001, 
                            springLength: 200 
                        }
                    },
                    interaction: { hover: true },
                    layout: { improvedLayout: true }
                });

                // Evento de click mejorado
                network.on("click", async function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        try {
                            const contextoRes = await axios.get('/contexto/');
                            const contexto = contextoRes.data[nodeId];
                            if (contexto) {
                                const relacionados = contexto.relaciones.map(rid => 
                                    contextoRes.data[rid]?.titulo || rid
                                ).join(', ') || 'Ninguno';
                                
                                alert(`üìã ${contexto.titulo}\n\nüìù ${contexto.texto}\n\nüîó Relacionados: ${relacionados}\n\nüè∑Ô∏è Palabras clave: ${contexto.palabras_clave.join(', ')}\n\nüÜî ID: ${nodeId}`);
                            }
                        } catch (error) {
                            alert(`Error cargando informaci√≥n del contexto: ${error.message}`);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error cargando grafo:', error);
                document.getElementById('grafo').innerHTML = `<div class="text-red-600 p-4">Error cargando grafo: ${error.message}</div>`;
            }
        }

        cargarGrafo(); // carga inicial

        async function mostrarContextos() {
            const res = await axios.get('/contexto/');
            const contextos = res.data;

            let salida = "";
            for (const [id, datos] of Object.entries(contextos)) {
                salida += `üü¶ T√≠tulo: ${datos.titulo}\nüìÑ Texto: ${datos.texto}\nüîó Relacionados: ${datos.relaciones.map(rid => contextos[rid]?.titulo || rid).join(', ') || 'Ninguno'}\nüîë Palabras clave: ${datos.palabras_clave.join(', ') || 'Ninguna'}\n\n`;
            }

            document.getElementById("todosContextos").innerText = salida || "No hay contextos almacenados a√∫n.";
        }

        async function buscarSemantico() {
            const texto = document.getElementById('textoBusqueda').value.trim();
            if (!texto) return;

            const res = await axios.get(`/buscar/?texto=${encodeURIComponent(texto)}`);
            const datos = res.data;

            const container = document.getElementById('resultadosBusqueda');
            container.innerHTML = '';

            if (Object.keys(datos).length === 0) {
                container.innerHTML = "<p>No se encontraron resultados.</p>";
                return;
            }
            console.log("Resultados de b√∫squeda:", datos);
            console.log("", Object.entries(datos));
            for (const [id, info] of Object.entries(datos)) {
                const div = document.createElement("div");
                div.className = "p-3 bg-gray-100 rounded border-l-4 border-pink-600 shadow";
                div.innerHTML = `
                <strong>üü£ ID:</strong> ${id}<br>
                <strong>üìë T√≠tulo:</strong> ${info.titulo}<br>
                <strong>üìÑ Texto:</strong> ${info.texto}
                `;
                container.appendChild(div);
            }
        }

        async function cargarEstadisticas() {
            try {
                const res = await axios.get('/estadisticas/');
                const stats = res.data;
                
                const container = document.getElementById('estadisticas');
                container.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <strong>üóÉÔ∏è Sistema:</strong><br>
                            <span class="inline-block mt-1 px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">
                                ${stats.storage_type}
                            </span>
                        </div>
                        <div>
                            <strong>üìä Contextos:</strong><br>
                            <span class="text-2xl font-bold text-green-600">${stats.total_contextos}</span>
                        </div>
                        <div>
                            <strong>üîó Relaciones:</strong><br>
                            <span class="text-2xl font-bold text-blue-600">${stats.total_relaciones}</span>
                        </div>
                        <div>
                            <strong>üéØ Densidad:</strong><br>
                            <span class="text-lg font-semibold">${(stats.densidad || 0).toFixed(3)}</span>
                        </div>
                        <div>
                            <strong>üåê Componentes:</strong><br>
                            <span class="text-lg font-semibold">${stats.componentes_conectados || 0}</span>
                        </div>
                        <div>
                            <strong>üíæ Tama√±o:</strong><br>
                            <span class="text-sm">${((stats.tama√±o_grafo_mb || 0) + (stats.tama√±o_metadatos_mb || 0)).toFixed(2)} MB</span>
                        </div>
                    </div>
                    ${stats.nodo_mas_conectado ? `
                    <div class="mt-3 p-2 bg-orange-50 border border-orange-200 rounded">
                        <strong>üèÜ Contexto M√°s Conectado:</strong><br>
                        <span class="text-sm">"${stats.nodo_mas_conectado.titulo}"</span><br>
                        <span class="text-xs text-gray-600">${stats.nodo_mas_conectado.conexiones} conexiones</span>
                    </div>
                    ` : ''}
                `;
            } catch (error) {
                document.getElementById('estadisticas').innerHTML = `<p class="text-red-600">Error cargando estad√≠sticas: ${error.message}</p>`;
            }
        }

        async function mostrarContextosCentrales() {
            try {
                const res = await axios.get('/grafo/centrales/');
                const centrales = res.data;
                
                const container = document.getElementById('contextosCentrales');
                if (centrales.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No hay suficientes contextos</p>';
                    return;
                }
                
                let html = '<ul class="space-y-1">';
                centrales.forEach((ctx, index) => {
                    html += `
                        <li class="flex items-center">
                            <span class="font-bold text-blue-600 mr-2">${index + 1}.</span>
                            <div>
                                <div class="font-semibold text-xs">${ctx.titulo.substring(0, 30)}.</div>
                                <div class="text-xs text-gray-500">Centralidad: ${ctx.centralidad}</div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('contextosCentrales').innerHTML = `<p class="text-red-600 text-xs">Error: ${error.message}</p>`;
            }
        }

        async function migrarASQLite() {
            alert('‚ÑπÔ∏è Esta funci√≥n ha sido reemplazada por el nuevo sistema de base de datos de grafos NetworkX, que es m√°s eficiente para nuestro caso de uso.');
        }
    </script>
</body>
</html>